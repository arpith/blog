---
layout: post
date: 2015-12-19 11:24:05 GMT
tags:
- reactjs
- web development
- javascript
- isomorphic app
- universal app
- koa
- ejs
- nodejs
- babeljs
- react-router
title: "Server Rendering with React Router"
---
# Server Rendering with React Router

<p>I build <a href="http://arpith.co/post/135409935907/universal-links-in-react-native">apps</a> and <a href="http://arpith.co/post/133345400442/a-double-page-app">websites</a>, and lately I&rsquo;ve been building <a href="http://arpith.co/post/133415247167/isomorphic-react-in-three-simple-steps">isomorphic/universal websites</a> with <a href="https://facebook.github.io/react/">React</a>. This is how you can use <a href="https://github.com/rackt/react-router">React Router</a> to <a href="https://github.com/rackt/react-router/blob/master/docs/guides/advanced/ServerRendering.md">render on the server</a> with <a href="http://koajs.com/">Koa</a>.</p><figure data-orig-width="540" data-orig-height="405" class="tmblr-full" data-orig-src="/images/a8101001186c985237e5e8d09a5b288494669b52266f26fcf72278276f1db3a0.jpg"><img src="/images/2ef021fd89a6fbf41565610ce03cfe83e57c5629bcd2176544b09bb15cbcbfca.jpg" data-orig-width="540" data-orig-height="405" data-orig-src="/images/a8101001186c985237e5e8d09a5b288494669b52266f26fcf72278276f1db3a0.jpg"></figure><p>The basics are straightforward:</p><ol><li>Your Koa app uses React Router&rsquo;s <a href="https://github.com/rackt/react-router/blob/master/docs/API.md#match-routes-location-options--cb">match()</a></li><li>match() takes your <a href="https://github.com/rackt/react-router/blob/0193e81bd220cbdddddeb4161af675ad6db99d57/docs/API.md#route">routes</a> and the url, and a callback</li><li>The callback will either receive an error or a redirect location or render props</li></ol><p>If you&rsquo;ve got an error or a redirect you can use Koa&rsquo;s this.throw and this.redirect, and if you&rsquo;ve got nothing you can throw a 404. On the other hand, if you&rsquo;ve got renderProps you can then pass React Router&rsquo;s &lt;<a href="https://github.com/rackt/react-router/blob/0193e81bd220cbdddddeb4161af675ad6db99d57/docs/API.md#routercontext">RouterContext</a> {&hellip;renderProps} /&gt; to <a href="https://facebook.github.io/react/docs/top-level-api.html#reactdomserver">react-dom/server</a>&rsquo;s <a href="https://facebook.github.io/react/docs/top-level-api.html#reactdomserver.rendertostring">renderToString</a>function.</p><pre>require('babel-core/register');<br>var ReactDOMServer = require('react-dom/server');<br>var ReactRouter = require('react-router');<br>var koa = require('koa');<br>var render = require('koa-ejs');<br>var path = require('path');<br>var RouterContext = require('./RouterContext');<br>var App = require('./components/App');</pre><pre>var app = koa();<br>render(app, {root: path.join(__dirname, 'view')});</pre><pre>app.use(function *() {<br> &nbsp;const routes = {<br> &nbsp; &nbsp;path: '/',<br> &nbsp; &nbsp;component: App<br> &nbsp;};<br><br> &nbsp;ReactRouter.match({<br> &nbsp; &nbsp;routes: routes,<br> &nbsp; &nbsp;location: this.url<br> &nbsp;}, (error, redirectLocation, renderProps) =&gt; {<br> &nbsp; &nbsp;if (error) {<br> &nbsp; &nbsp; &nbsp;this.throw(error.message, 500);<br> &nbsp; &nbsp;} else if (redirectLocation) {<br> &nbsp; &nbsp; &nbsp;this.redirect(redirectLocation.pathname + redirectLocation.search);<br> &nbsp; &nbsp;} else if (renderProps) {<br> &nbsp; &nbsp; &nbsp;var reactString = ReactDOMServer.renderToString(RouterContext(renderProps));<br> &nbsp; &nbsp; &nbsp;this.render('layout', {react: reactString});<br> &nbsp; &nbsp;} else {<br> &nbsp; &nbsp; &nbsp;this.throw('Not Found', 404);<br> &nbsp; &nbsp;}<br> &nbsp;});<br>});</pre><pre>var port = process.env.PORT || 3000;<br> &nbsp;app.listen(port);<br>});</pre><p>A couple of things thrown in there:<br></p><ol><li>I&rsquo;m using <a href="https://babeljs.io/">Babel&rsquo;s</a> <a href="https://babeljs.io/docs/usage/require/">require hook</a> to support the jsx in my <a href="https://facebook.github.io/react/">React</a> component</li><li><a href="http://stackoverflow.com/a/29425761">This doesn&rsquo;t transpile the file it&rsquo;s in</a>, so I&rsquo;m using <a href="https://github.com/rackt/react-router/blob/master/docs/API.md#plainroute">plain routes</a></li><li>This is also why I&rsquo;ve placed &lt;RouterContext /&gt; in a separate file</li><li>Finally, I&rsquo;m using <a href="https://www.npmjs.com/package/koa-ejs">koa-ejs</a> to <a href="http://arpith.co/post/134265953082/server-side-react-ejs">provide the HTML around the react string</a>.</li></ol><p>My RouterContext.jsx looks like:</p><pre>var React = require('react');<br>var RoutingContext = require('react-router').RoutingContext;<br>module.exports = (renderProps) =&gt; &lt;RoutingContext {&hellip;renderProps} /&gt;;</pre><p>This is because the <a href="https://github.com/rackt/react-router/releases/tag/v1.0.2">current version</a> of React Router provides RoutingContext which has since been renamed to RouterContext (<a href="https://github.com/rackt/react-router/issues/2713">which is what the docs talk about</a>).</p><p>That&rsquo;s about it! <a href="http://twitter.com/arpith">Let</a> <a href="http://arpith.co/">me</a> <a href="http://medium.com/@arpith">know</a> your thoughts and suggestions!</p>